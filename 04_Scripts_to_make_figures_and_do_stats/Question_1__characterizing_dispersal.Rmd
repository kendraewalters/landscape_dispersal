---
title: "Question_1__characterizing_dispersal"
author: "Kendra E. Walters"
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: no
    lib_dir: libs
    code_folding: hide
    toc: yes
    toc_float: TRUE
editor_options: 
  chunk_output_type: console
---
<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>

# Purpose

To answer our first overarching question for the landscape dispersal project: Is the rate and composition of microbial dispersal into the soil surface spatially heterogeneous? 

Because vegetation appears to be a primary route through which bacteria disperse, we hypothesized that the taxa dispersing and their dispersal rate onto the soil surface will differ between two ecosystems. In fact, we know that bacterial abundance and composition in one grassland and CSS plant litter differs.


```{r setup, message=FALSE}
library(tidyverse)
library(data.table)
library(knitr)
library(kableExtra)
require(ggplot2)
require(gridExtra)
library(car)


knitr::opts_chunk$set(comment="", cache=T, warning = F, message = F, fig.path = "../05_output_figures/")
```

# Abundance on glass slides

First, we'll look at the abundances on the glass slides over time to see if they are acculumulating or at equilibrium. 

```{r boxplot_glass_slide_abundance_by_ecosystem}
# Load the data
flow.data <- load("../03_Processed_data/flow_cytometry_cleaned.rda")
metadata <- load("../03_Processed_data/metadata_cleaned.rda")


# Left join fights me unless both columns are the same data type
metadata.together$`Random_#_Flow` <- as.character(metadata.together$`Random_#_Flow`)


# Set up a key to change time point into # of days
days.key <- c("0" = 0, "1" = 12, "2" = 26, "3" = 47, "4" = 54)


# Clean up our data to just be what we need for this analysis 
cell.counts.use <- cleaned.cell.counts %>% left_join(metadata.together) %>% # combine with metadata using Random_#_Flow
  mutate(Treatment = ifelse(is.na(Treatment), "Death", Treatment)) %>% # add metadata for T0 samples that weren't included in the overall metadata file
  mutate(Time_Point = ifelse(is.na(Time_Point), 0, Time_Point)) %>% 
  mutate(Ecosystem = ifelse(grepl("^g", `Random_#_Flow`), "Grassland",
                            ifelse(grepl("^s", `Random_#_Flow`), "Shrubland", Ecosystem))) %>%
  select(number_cells_on_glass_slide_cleaned, Treatment, Ecosystem, Time_Point) %>% # reduce to only columns we need
  filter(Treatment != "Closed") %>% # remove this negative control (should have been removed prior to this script)
  mutate(Time_as_days = days.key[as.character(Time_Point)]) # make column that lists # of days


# Plot this as a boxplot to give a general sense of what the abundance on the glass slides are doing
ggplot(data = cell.counts.use %>% filter(Treatment == "Open")) +
  geom_boxplot(aes(x = as.factor(Time_Point), y = number_cells_on_glass_slide_cleaned)) + 
  facet_wrap(vars(Ecosystem))
```

# Immigration rate calculations assuming population growth

Okay, seems like the immigration rate is faster than the death rate for the first three timepoints, and then a plateau is potentially being reached. We can model this increase and plateau using the integral of our population "growth" equation (with just immigration and death). 

dn/dt = i - d*n(t) where n = abundance on glass slides, i = immigration rate, and d = death rate

So the integral is (when forced to go through the origin): 
n(t) = i/d * (1 - e^(-d*t))

```{r scatterplot_abundance_glass_slides_by_ecosystem}
# plotting our data with our fancy integral equation going through the origin
ggplot(data = cell.counts.use %>% filter(Treatment == "Open") %>% 
  mutate(Time_as_days= as.integer(Time_as_days)), 
       aes(x = Time_as_days, y = number_cells_on_glass_slide_cleaned)) +
  geom_point() + 
  geom_smooth(method = "nls", formula = "y ~  (Im / d) * (1 - exp(-d * x))", se=F, 
              method.args = list(start=c(Im=2e5, d=0.034))) +
  facet_wrap(vars(Ecosystem)) 


# Separate into our two ecosystems
grass.cells <- cell.counts.use %>% filter(Ecosystem == "Grassland")
shrub.cells <- cell.counts.use %>% filter(Ecosystem == "Shrubland")


# Calculating the death rate and immigration rate coefficients
(nls.shrub <- nls(number_cells_on_glass_slide_cleaned ~  Im/d * (1 - exp(-d * Time_as_days)), 
               data = shrub.cells[shrub.cells$Treatment == "Open", ],
               start = list(Im = 2e5, d = 0.034)) %>% summary) 
(nls.grass <- nls(number_cells_on_glass_slide_cleaned ~  Im/d * (1 - exp(-d * Time_as_days)), 
               data = grass.cells[grass.cells$Treatment == "Open", ],
               start = list(Im = 2e5, d = 0.034)) %>% summary)

# note: use summary(model) to look at standard error, which is HUGE for the death rate and fairly large for the immigration rate
```

But we don't actually need to have the model guess what the death rate is because we measured death rate with our death rate glass slides. So let's plot that data now and calculate our death rate for the grassland and shrubland. 

```{r scatterplot_death_rate_by_ecosystem}
# Calculating death rate for the grassland death slides
intercept.grass <- grass.cells %>% 
  filter(Treatment == "Death", 
         Time_as_days == 0) %>% 
  summarize(mean = mean(log(number_cells_on_glass_slide_cleaned)))

r.grass <- lm(I(log(number_cells_on_glass_slide_cleaned) - intercept.grass[[1]]) ~ Time_as_days + 0, 
               grass.cells %>% filter(Treatment == "Death")) %>% coef*-1 # THIS IS THE DEATH RATE!! (we do negative because this is actually describing the continuous rate at which cells survive, not the continuous rate at which cells die)
print(paste0("Continuous death rate for grassland cells is ", round(r.grass, 4), "."))
  

# Calculating death rate for the grassland death slides
intercept.shrub <- shrub.cells %>% 
  filter(Treatment == "Death", 
         Time_as_days == 0) %>% 
  summarize(mean = mean(log(number_cells_on_glass_slide_cleaned)))

r.shrub <- lm(I(log(number_cells_on_glass_slide_cleaned) - intercept.shrub[[1]]) ~ Time_as_days + 0, 
               shrub.cells %>% filter(Treatment == "Death")) %>% coef*-1 # THIS IS THE DEATH RATE!! (we do negative because this is actually describing the continuous rate at which cells survive, not the continuous rate at which cells die)
print(paste0("Continuous death rate for shrubland cells is ", round(r.shrub, 4), "."))


# creating a mini data frame to give our parameters for the linear models (since we are picky about our intercepts here)
lm.parameters.death <- data.frame("Intercept" = c(intercept.grass[[1]], intercept.shrub[[1]]), 
                                  "Slope" = c(r.grass[[1]], r.shrub[[1]]), 
                                  "Ecosystem" = c("Grassland", "Shrubland"))


# plotting our death rate data
ggplot(data = cell.counts.use %>% filter(Treatment == "Death") %>% 
  mutate(Time_as_days= as.integer(Time_as_days)), 
       aes(x = Time_as_days, y = log(number_cells_on_glass_slide_cleaned))) +
  geom_point() + 
  geom_abline(data = lm.parameters.death, aes(intercept = Intercept, slope = -Slope)) + 
  facet_wrap(vars(Ecosystem))

```

Sweet! Now we can use these death rates to input into our model so we are only asking it to find the estimate for the immigration rate. Note how much smaller the standard errors are for these immigration rates! 

```{r scatterplot_abundance_glass_slides_with_measured_death_rate_by_ecosystem}
# Calculating the death rate and immigration rate coefficients WITH measured death rates
(nls.shrub <- nls(number_cells_on_glass_slide_cleaned ~  
                    Im/0.02372169 * (1 - exp(-0.02372169 * Time_as_days)), 
               data = shrub.cells[shrub.cells$Treatment == "Open", ],
               start = list(Im = 2e5)) %>% summary) 
(nls.grass <- nls(number_cells_on_glass_slide_cleaned ~ 
                    Im/0.03106574 * (1 - exp(-0.03106574 * Time_as_days)), 
               data = grass.cells[grass.cells$Treatment == "Open", ],
               start = list(Im = 2e5)) %>% summary)


# Graph the new curves that we made
A <- ggplot(data = grass.cells %>% filter(Treatment == "Open") %>% 
  mutate(Time_as_days= as.integer(Time_as_days)), 
       aes(x = Time_as_days, y = number_cells_on_glass_slide_cleaned)) +
  geom_point() + 
  geom_smooth(method = "nls", formula = "y ~  (Im / 0.03106574) * (1 - exp(-0.03106574 * x))", se=F, 
              method.args = list(start=c(Im=2e5))) +
  ggtitle("Grassland")

B <- ggplot(data = shrub.cells %>% filter(Treatment == "Open") %>% 
  mutate(Time_as_days= as.integer(Time_as_days)), 
       aes(x = Time_as_days, y = number_cells_on_glass_slide_cleaned)) +
  geom_point() + 
  geom_smooth(method = "nls", formula = "y ~  (Im / 0.02372169) * (1 - exp(-0.02372169 * x))", se=F, 
              method.args = list(start=c(Im=2e5))) +
  ggtitle("Shrubland")

grid.arrange(A,B, nrow = 1)

```

# Immigration rate calculations assuming equilibrium
Looking at the first graph of abundance on the glass slides above, it seems that, on and after the third time point, the abundance on the glass slides is at equilibrium. Actually, for the grassland, it looks like abundance dips a little, either driven by higher death rate or lower immigration rate, so we can just use the third timepoint to calculate our immigration rate at equilibrium. 


```{r immigration_rate_at_equilibrium}
# Calculate immigration rate for the grassland 
imm.grass <- grass.cells %>% filter(Treatment == "Open", Time_Point %in% c("3")) %>% 
  summarize(mean = mean(number_cells_on_glass_slide_cleaned)) * r.grass

print(paste0("The immigration rate for the grassland is ", imm.grass, " cells / day."))

# Calculate immigration rate for the shrubland 
imm.shrub <- shrub.cells %>% filter(Treatment == "Open", Time_Point %in% c("3")) %>% 
  summarize(mean = mean(number_cells_on_glass_slide_cleaned)) * r.shrub

print(paste0("The immigration rate for the shrubland is ", imm.shrub, " cells / day."))
```


# Death rates by ecosystem
One potentially interesting question is if death rates differ by ecosystem. We can answer this question by running an ANCOVA on the abundance in the death slides, to see if there is an interaction between time and ecosystem. 
```{r death_rates_by_ecosystem}
cell.counts.use %>% filter(Treatment == "Death") %>% 
  mutate([SOMETHING] = ifelse([SOMETHING] == "Shrub", [SOMETHING] - intercept.shrub, 
                              ifelse([SOMETHING] == "Grass", [SOMETHING] - intercept.grass, "WHOOPS"))) %>% 
  lm(formula = I(log10(Abundance)) ~ Time_as_days:Treatment + Time_as_days + 0, data = .), type = "II") %>% # independent of order
  Anova
  
intercept.table <- mean(log10(big[big$Time_as_days == 0, ]$Abundance)) # intercept.table and intercept.ground are the same
Anova(lm(formula = I(log10(Abundance)-intercept.table) ~ Time_as_days:Treatment + Time_as_days + 0, data = big), type = "II") # independent of order  
```

# Taxa dying at different rates? 
Another potentially interesting question is if taxa on the death rate slides die at different rates. We can answer this question by running PERMANOVA on the death rate samples to see if time influences either 16S or ITS composition. 
```{r NMDS_taxa_specific_death_rates_bacteria}
# Load data
glass.slides.16S <- "../../../03_Processed_data/16S_glass_slides.rda"
load(glass.slides.16S)

# Create our visualization, just for fun
NMDS1 <- metaMDS(q1.bray.dist, autotransform = FALSE, k = 2) %>% data.frame(NMDS1$points[,1:2]) %>% 
  left_join(metadata.together) %>% 
  ggplot(data = .) +
  geom_point(aes(x = MDS1, y = MDS2, color = as.factor(TimePoint)), size = 4) + 
  theme_classic() +
  scale_color_brewer(palette = "Set1") 

# Do the PERMANOVA that will test our hypothesis
adonis(q1.bray.dist.df ~ TimePoint, permutations = 10000, 
       data = metadata.together, na.rm= TRUE)

adonis(q1.bray.dist.df ~ TimePoint * as.factor(Ecosystem), permutations = 10000, 
       data = metadata.together, na.rm= TRUE)
```


```{r NMDS_taxa_specific_death_rates_fungi}

print("I haven't cleaned the data yet so fungal analyses are yet to come. :/")

# Load data
# glass.slides.16S <- "../../../03_Processed_data/16S_glass_slides.rda"
# load(glass.slides.16S)
# 
# NMDS1 <- metaMDS(q1.bray.dist, autotransform = FALSE, k = 2) %>% data.frame(NMDS1$points[,1:2]) %>% 
#   left_join(metadata.together) %>% 
#   ggplot(data = .) +
#   geom_point(aes(x = MDS1, y = MDS2, color = as.factor(TimePoint)), size = 4) + 
#   theme_classic() +
#   scale_color_brewer(palette = "Set1") 
# 
# adonis(q1.bray.dist.df ~ TimePoint, permutations = 10000, 
#        data = metadata.together, na.rm= TRUE)
# 
# adonis(q1.bray.dist.df ~ TimePoint * as.factor(Ecosystem), permutations = 10000, 
#        data = metadata.together, na.rm= TRUE)
```


# Dispersal communities by ecosystem
A key question of this study is - Do different ecosystems (plant communities) have different dispersal communities? To answer this question, we will use a PERMANOVA to see if different ecosystems show different bacterial and fungal communities on the glass slides. 